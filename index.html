<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIFF Face Challenge</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        .container { position: relative; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        video#webcam { position: absolute; width: 100%; height: auto; transform: scaleX(-1); }
        canvas#output_canvas { position: absolute; width: 100%; height: auto; transform: scaleX(-1); }
        
        #instruction-box { 
            position: absolute; top: 15%; width: 80%; 
            background: rgba(0,0,0,0.8); padding: 20px; 
            border-radius: 15px; text-align: center; border: 2px solid #00b900;
            z-index: 30;
        }
        #step-text { font-size: 1.5rem; font-weight: bold; color: #fff; }
        #logout-btn { position: absolute; top: 20px; right: 20px; background: #ff4b4b; color: white; border: none; padding: 8px 15px; border-radius: 5px; z-index: 40; }
    </style>
</head>
<body>

    <button id="logout-btn" onclick="liff.logout(); window.location.reload();">Logout</button>

    <div class="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
        
        <div id="instruction-box">
            <div id="step-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const stepText = document.getElementById('step-text');

        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Challenge: 0=‡∏°‡∏≠‡∏á‡∏ï‡∏£‡∏á, 1=‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢, 2=‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤, 3=‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
        let currentStep = 0;
        let isProcessing = false;

        const STEPS = [
            { msg: "STEP 1: ‡∏°‡∏≠‡∏á‡∏ï‡∏£‡∏á", color: "#00b900" },
            { msg: "STEP 2: ‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á ''‡∏Ç‡∏ß‡∏≤' ‚û°Ô∏è", color: "#ffcc00" },
            { msg: "STEP 3: ‡∏´‡∏±‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏ó‡∏≤‡∏á ‡∏ã‡πâ‡∏≤‡∏¢' ‚¨ÖÔ∏è", color: "#ffcc00" },
            { msg: "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤...", color: "#00ff00" }
        ];

       async function initLIFF() {
    await liff.init({ liffId: "2008745485-1xvYlrHE" });
    if (!liff.isLoggedIn()) { 
        liff.login(); 
    } else { 

        stepText.innerText = STEPS[0].msg;
        startCamera(); 
    }
}

        function onResults(results) {
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0 && !isProcessing) {
                const landmarks = results.multiFaceLandmarks[0];
                //drawConnectors(canvasCtx, landmarks, FACEMESH_TESSELATION, {color: '#C0C0C070', lineWidth: 1});

                const nose = landmarks[1].x;
                const left = landmarks[234].x;
                const right = landmarks[454].x;
                const ratio = (nose - left) / (right - left);

                // Logic ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Step
                if (currentStep === 0 && ratio > 0.4 && ratio < 0.6) {
                    nextStep(); // ‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≠‡∏á‡∏ï‡∏£‡∏á
                } else if (currentStep === 1 && ratio < 0.3) {
                    nextStep(); // ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                } else if (currentStep === 2 && ratio > 0.7) {
                    nextStep(); // ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏±‡∏ô‡∏Ç‡∏ß‡∏≤
                }
            }
            canvasCtx.restore();
        }

        function nextStep() {
            currentStep++;
            if (currentStep < 3) {
                stepText.innerText = STEPS[currentStep].msg;
                // ‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á Beep ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
            } else if (currentStep === 3 && !isProcessing) {
                isProcessing = true;
                stepText.innerText = STEPS[3].msg;
                handleCheckin();
            }
        }

        async function handleCheckin() {
            const profile = await liff.getProfile();
            stepText.innerText = "üìç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î...";

        // 1. ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
       const pos = await new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(resolve, (err) => {
        // ‡∏ñ‡πâ‡∏≤‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î 0,0 ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        console.warn("Geolocation error:", err.message);
        resolve({ coords: { latitude: 0, longitude: 0 } }); 
    }, {
        enableHighAccuracy: false, // ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô false ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å Cell Site/WiFi ‡πÑ‡∏î‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà GPS ‡∏ï‡∏£‡∏á‡πÜ)
        timeout: 10000,           // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        maximumAge: 30000         // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏î‡∏∂‡∏á‡πÑ‡∏ß‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    });
});
    // 1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
    const payload = {
        userId: profile.userId,
        displayName: profile.displayName,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        timestamp: new Date().toISOString()
    };

    try {
        console.log(payload);
        
        const response = await fetch(' https://4b48ad0c451b.ngrok-free.app/webhook/3d60a618-2c25-4f3d-b629-a06dc710107d', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            console.log("Data sent to n8n successfully!");
            liff.closeWindow(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
        } else {
            console.error("Failed to send data:", response.statusText);
        }
    } catch (error) {
        console.error("Error calling webhook:", error);
    }

        }

        const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5 });
        faceMesh.onResults(onResults);

        function startCamera() {
            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceMesh.send({image: videoElement}); },
                width: 640, height: 480
            });
            camera.start();
        }

        initLIFF();
    </script>
</body>

</html>






